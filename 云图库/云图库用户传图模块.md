## 用户上传图片及审核

控制首页未过审的图片不可见已经通过后端接口实现，我们只需开发管理员审核和按审核状态筛选图片功能即可。9JcB9KvGktsJeCekY//R96Nlv+uCpT8TeUU7sYgObzE=

#### 1、定义审核常量

和后端一样，前端也有很多地方要用到审核状态信息，可以定义为一个常量。

在 `constants` 目录下新建 picture.ts 常量文件，定义枚举信息、对应的中文映射、以及后续筛选审核状态时要用到的选项数组：

```javascript
export const PIC_REVIEW_STATUS_ENUM = {  
  REVIEWING: 0,  
  PASS: 1,  
  REJECT: 2,  
}  
  
export const PIC_REVIEW_STATUS_MAP = {  
  0: '待审核',  
  1: '通过',  
  2: '拒绝',  
}  
  
export const PIC_REVIEW_STATUS_OPTIONS = Object.keys(PIC_REVIEW_STATUS_MAP).map((key) => {  
  return {  
    label: PIC_REVIEW_STATUS_MAP[key],  
    value: key,  
  }  
})
```

#### 2、管理员审核功能

1）表格列新增审核信息：9JcB9KvGktsJeCekY//R96Nlv+uCpT8TeUU7sYgObzE=

```csharp
const columns = [  
  // ...  
  {  
    title: '审核信息',  
    dataIndex: 'reviewMessage',  
  },  
  // ...  
]
```

2）自定义审核信息列要展示的内容：

```php-template
<!-- 审核信息 -->  
<template v-if="column.dataIndex === 'reviewMessage'">  
  <div>审核状态：{{ PIC_REVIEW_STATUS_MAP[record.reviewStatus] }}</div>  
  <div>审核信息：{{ record.reviewMessage }}</div>  
  <div>审核人：{{ record.reviewerId }}</div>  
</template>
```

3）新增审核通过和拒绝的操作按钮：

```php-template
<template v-else-if="column.key === 'action'">  
  <a-space wrap>  
    <a-button  
      v-if="record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.PASS"  
      type="link"  
      @click="handleReview(record, PIC_REVIEW_STATUS_ENUM.PASS)"  
    >  
      通过  
    </a-button>  
    <a-button  
      v-if="record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.REJECT"  
      type="link"  
      danger  
      @click="handleReview(record, PIC_REVIEW_STATUS_ENUM.REJECT)"  
    >  
      拒绝  
    </a-button>  
    <a-button type="link" :href="`/add_picture?id=${record.id}`" target="_blank"  
      >编辑  
    </a-button>  
    <a-button type="link" danger @click="doDelete(record.id)">删除</a-button>  
  </a-space>  
</template>
```

4）编写审核函数，调用后端完成操作：9JcB9KvGktsJeCekY//R96Nlv+uCpT8TeUU7sYgObzE=

```typescript
const handleReview = async (record: API.Picture, reviewStatus: number) => {  
  const reviewMessage = reviewStatus === PIC_REVIEW_STATUS_ENUM.PASS ? '管理员操作通过' : '管理员操作拒绝'  
  const res = await doPictureReviewUsingPost({  
    id: record.id,  
    reviewStatus,  
    reviewMessage,  
  })  
  if (res.data.code === 0) {  
    message.success('审核操作成功')  
    // 重新获取列表  
    fetchData()  
  } else {  
    message.error('审核操作失败，' + res.data.message)  
  }  
}
```

#### 3、按审核状态筛选

只需要在原来的搜索表单中补充一个表单项即可，使用下拉框组件，传入定义好的审核状态常量作为选项：B2z6448PQSc3P5d8RibCpEJZ9ZaX16ayHXniF5A52nY=

```php-template
<a-form-item label="审核状态" name="reviewStatus">  
  <a-select  
    v-model:value="searchParams.reviewStatus"  
    :options="PIC_REVIEW_STATUS_OPTIONS"  
    placeholder="请输入审核状态"  
    style="min-width: 180px"  
    allow-clear  
  />  
</a-form-item>
```

#### 前端扩展

1）审核通过或拒绝时可以填写原因，可以利用 [模态框组件](https://antdv.com/components/modal-cn) 实现ChdipREN0jrjiXgJ/YkPo5ufCLwmKJhcbf8H+qMVE48=

2）可以在详情页添加审核通过、审核拒绝的快捷操作按钮，仅管理员可见

3）删除和拒绝属于危险操作，可以点击后提示确认框，确认后才执行操作。可以利用 [组件](https://antdv.com/components/popconfirm-cn) 实现

### 测试

测试流程：

1.  普通用户上传图片，此时主页看不到这张图片
    
2.  管理员操作过审，主页就可以看到这张图片
    
3.  管理员操作拒绝，主页将无法看到这张图片
    

运行效果如图：TJqV4WBBT2IFrp0o3vsnkggN7VzNkVQlxvcX5lXRIJI=

!\[\](![image](https://pic.code-nav.cn/course_picture/1608440217629360130/HZvrm6emGfos4ysl.webp)![](https://pic.code-nav.cn/course_picture/1619930914211520514/7mHR2JVTaEZFAHMJ.webp)

Q：有同学说，用户现在看不到自己被拒绝的图片啊？怎么修改？

A：本项目后续会带大家开发用户个人空间，到时候会完成这个功能。B2z6448PQSc3P5d8RibCpEJZ9ZaX16ayHXniF5A52nY=

### 扩展

#### 1、更多审核策略

在实际企业中，为了提高审核效率、减少垃圾内容，同时保证用户体验和平台的安全性，常常会结合技术手段和业务策略来优化审核流程。比如下面几点，大家可以按需扩展：iIeB8mD2J1oXqiOtY3taWTPWsqKxcGCkYX8MdOVhu+A=

1.  内容安全审核服务：借助专业的第三方平台的内容审核服务来实现自动审核，像腾讯云、阿里云等基本都支持图片、文本、音视频等内容的审核。
    
2.  AI 审核：可以将文本内容和审核规则输入给 AI，让 AI 返回是否合规。
    
3.  分级审核策略：区分普通用户与高信誉用户，高信誉用户可减少或免除审核流程，比如 VIP 用户自动过审，也可以提高部分效率。
    
4.  实名信息和内容溯源：通过用户实名或者手机号注册，提高用户行为的责任感，减少垃圾内容的产生。
    
5.  举报机制：通过给平台增加举报机制，还可以给举报行为一些奖励，让用户帮忙维护平台。
    

#### 2、审核通知

当管理员完成审核后，系统可以通过消息中心或邮件通知用户审核结果。sV0XXF40kQah+NcVxFP1y4nQNGtV/XyQvOt/FJKWUoA=



## 通过URL导入图片
和本地上传图片的开发流程一样，我们先来开发一个 URL 上传图片的组件，绝大多数代码都可以复用本地上传图片组件。uPqbd3DiPd3iSPyF1TJ20nEUpYukqZektmm49mRYrTY=

#### 1、URL 上传组件

URL 上传组件 = 文本输入框 + 提交按钮

可以使用组件库的 [复合输入框组件](https://antdv.com/components/input-cn#components-input-demo-group)：xo0dnOlnBf7Ws27/qGm2TPReUJyIxD/DuwJOjlvKUe0=

```php-template
<div class="url-picture-upload">  
  <a-input-group compact style="margin-bottom: 16px">  
    <a-input v-model:value="fileUrl" style="width: calc(100% - 120px)" placeholder="请输入图片 URL" />  
    <a-button type="primary" :loading="loading" @click="handleUpload" style="width: 120px">提交</a-button>  
  </a-input-group>  
  <img v-if="picture?.url" :src="picture?.url" alt="avatar" />  
</div>
```

开发上传操作函数，需要将用户输入的 fileUrl 提交到后端：

```csharp
const loading = ref<boolean>(false)  
const fileUrl = ref<string>()  
  
/**  
 * 上传  
 */  
const handleUpload = async () => {  
  loading.value = true  
  try {  
    const params: API.PictureUploadRequest = { fileUrl: fileUrl.value }  
    if (props.picture) {  
      params.id = props.picture.id  
    }  
    const res = await uploadPictureByUrlUsingPost(params)  
    if (res.data.code === 0 && res.data.data) {  
      message.success('图片上传成功')  
      // 将上传成功的图片信息传递给父组件  
      props.onSuccess?.(res.data.data)  
    } else {  
      message.error('图片上传失败，' + res.data.message)  
    }  
  } catch (error) {  
    message.error('图片上传失败')  
  } finally {  
    loading.value = false  
  }  
}
```

#### 2、开发创建页面

之前已经开发了创建图片页面，可以在上传图片时增加一个 [Tabs 选项组件](https://antdv.com/components/tabs-cn)，让用户自己选择上传方式。

```php-template
<!-- 选择上传方式 -->  
<a-tabs v-model:activeKey="uploadType"  
  >>  
  <a-tab-pane key="file" tab="文件上传">  
    <PictureUpload :picture="picture" :onSuccess="onSuccess" />  
  </a-tab-pane>  
  <a-tab-pane key="url" tab="URL 上传" force-render>  
    <UrlPictureUpload :picture="picture" :onSuccess="onSuccess" />  
  </a-tab-pane>  
</a-tabs>
```

定义上传类型变量：

```csharp
const uploadType = ref<'file' | 'url'>('file')
```

其他代码都不需要调整。你会发现只要开发思路清晰、代码结构良好，新功能的扩展是很快的~iIeB8mD2J1oXqiOtY3taWTPWsqKxcGCkYX8MdOVhu+A=

### 测试

没上传图片时，效果如图：

![](![image](https://pic.code-nav.cn/course_picture/1608440217629360130/43YAQGJVWeswOZQG.webp)

上传图片后，效果如图：

![](![image](https://pic.code-nav.cn/course_picture/1608440217629360130/neyPbngNsSstry0S.webp)

除了创建外，最好也测试下修改图片，防止优化代码的过程中出现了疏漏。iIeB8mD2J1oXqiOtY3taWTPWsqKxcGCkYX8MdOVhu+A=


## 批量抓取和创建图片
可以新建一个批量创建图片页面，并且在图片管理页面补充跳转到该页面的按钮。uPqbd3DiPd3iSPyF1TJ20nEUpYukqZektmm49mRYrTY=

#### 1、图片管理页面补充按钮

管理页面补充 “批量创建图片” 按钮，代码如下：

```php-template
<a-space>  
  <a-button type="primary" href="/add_picture" target="_blank">+ 创建图片</a-button>  
  <a-button type="primary" href="/add_picture/batch" target="_blank" ghost>+ 批量创建图片</a-button>  
</a-space>
```

效果如图：

!\[\](![image](https://pic.code-nav.cn/course_picture/1608440217629360130/1l3hlZR4xUxHhnBM.webp)![](https://pic.code-nav.cn/course_picture/1619930914211520514/QyLXKRrhEznKr6aE.webp)

#### 2、批量创建图片页面

1）新建页面文件 `AddPictureBatchPage.vue`（复制创建图片页面），并添加路由：

```css
{  
  path: '/add_picture/batch',  
  name: '批量创建图片',  
  component: AddPictureBatchPage,  
}
```

正常情况下，普通用户是看不见该页面的，即使看见了，也会因为后端的限制无法使用。TJqV4WBBT2IFrp0o3vsnkggN7VzNkVQlxvcX5lXRIJI=

2）该页面主体是一个表单，和创建图片页面极为相似，先修改表单项：

```php-template
<div id="addPictureBatchPage">  
  <h2 style="margin-bottom: 16px">批量创建图片</h2>  
  <a-form layout="vertical" :model="formData" @finish="handleSubmit">  
    <a-form-item label="关键词" name="searchText">  
      <a-input v-model:value="formData.searchText" placeholder="请输入关键词" />  
    </a-form-item>  
    <a-form-item label="抓取数量" name="count">  
      <a-input-number  
        v-model:value="formData.count"  
        placeholder="请输入数量"  
        style="min-width: 180px"  
        :min="1"  
        :max="30"  
        allow-clear  
      />  
    </a-form-item>  
    <a-form-item label="名称前缀" name="namePrefix">  
      <a-input v-model:value="formData.namePrefix" placeholder="请输入名称前缀，会自动补充序号" />  
    </a-form-item>  
    <a-form-item>  
      <a-button type="primary" html-type="submit" style="width: 100%" :loading="loading">  
        执行任务  
      </a-button>  
    </a-form-item>  
  </a-form>  
</div>
```

注意，由于批量抓取任务是同步的，可能比较慢，所以需要添加 loading 效果，防止点击过快重复执行。B2z6448PQSc3P5d8RibCpEJZ9ZaX16ayHXniF5A52nY=

定义表单项结构和 loading 变量：

```csharp
const formData = reactive<API.PictureUploadByBatchRequest>({  
  count: 10,  
})  
const loading = ref(false)
```

3）编写提交函数，抓取成功后会输出信息并跳转到主页：uPqbd3DiPd3iSPyF1TJ20nEUpYukqZektmm49mRYrTY=

```kotlin
const handleSubmit = async (values: any) => {  
  loading.value = true;  
  const res = await uploadPictureByBatchUsingPost({  
    ...formData,  
  })  
  if (res.data.code === 0 && res.data.data) {  
    message.success(`创建成功，共 ${res.data.data} 条`)  
    router.push({  
      path: '/',  
    })  
  } else {  
    message.error('创建失败，' + res.data.message)  
  }  
  loading.value = false;  
}
```

### 测试

批量创建页面效果如图：TJqV4WBBT2IFrp0o3vsnkggN7VzNkVQlxvcX5lXRIJI=

![](![image](https://pic.code-nav.cn/course_picture/1608440217629360130/tOSFJVF05eRTRrGG.webp)

可以随意输入关键词进行测试，这下爽了，无论你想做表情包网站、设计素材网站、海报网站、Logo 网站、还是壁纸网站，全都可以轻松完成！

!\[\](![image](https://pic.code-nav.cn/course_picture/1608440217629360130/V0cfpwlqBqtSxMai.webp)![](https://pic.code-nav.cn/course_picture/1619930914211520514/JcoR8S6uMPkjroeU.webp)sV0XXF40kQah+NcVxFP1y4nQNGtV/XyQvOt/FJKWUoA=

**友情提示，虽然本项目在功能上的目标是商业级平台，但一定要注意版权问题，不能随意拿别人的素材来商用。**

### 扩展

1）支持管理员填写每批抓取图片的偏移量，防止重复抓取。NYk9omRRbMtb6eYnCAArAErDvMuLhxdFfhahbRdMVZs=

2）系统内部记录原始图片 URL，便于内部复盘归档，但是注意不需要暴露给用户。

3）和批量设置名称一样，支持批量设置抓取到的图片的分类和标签等。

4）我们目前抓取到的图片清晰度有限，可以尝试能否获取到质量更高的图片。uPqbd3DiPd3iSPyF1TJ20nEUpYukqZektmm49mRYrTY=

## 最后

讲到这里，好像我们的公开图库平台功能已经比较完善了，现在就可以上线给别人用了嘛！

如果你也是这个想法，那真的是。。。xo0dnOlnBf7Ws27/qGm2TPReUJyIxD/DuwJOjlvKUe0=

**太惨啦！**

现在上线，得亏死啊！在下一节教程中，鱼皮会带大家做一些重要的优化点，加油学习吧！

uPqbd3DiPd3iSPyF1TJ20nEUpYukqZektmm49mRYrTY=